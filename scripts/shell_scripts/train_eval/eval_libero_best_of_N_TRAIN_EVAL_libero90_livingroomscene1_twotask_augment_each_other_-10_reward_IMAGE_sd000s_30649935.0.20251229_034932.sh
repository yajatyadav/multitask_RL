#!/usr/bin/env bash

# Best-of-N Evaluation Jobs
# All jobs run in WANDB_MODE=offline

jobid0=$(WANDB_MODE=offline WANDB_SERVICE_WAIT=86400 WANDB_NETWORK_TIMEOUT=600 WANDB_FILE_TRANSFER_TIMEOUT=1200 WANDB_INIT_TIMEOUT=300 WANDB_HTTP_TIMEOUT=600 WANDB_RETRY_ATTEMPTS=15 WANDB_RETRY_WAIT_MIN=5 WANDB_RETRY_WAIT_MAX=120 MUJOCO_GL=egl XLA_PYTHON_CLIENT_PREALLOCATE=false OMP_NUM_THREADS=1 OPENBLAS_NUM_THREADS=1 MKL_NUM_THREADS=1 VECLIB_MAXIMUM_THREADS=1 NUMEXPR_NUM_THREADS=1 sbatch -A co_rail -p savio4_gpu --gres=gpu:A5000:1 -N 1 -n 1 -c 4 --qos=rail_gpu4_high -t 24:00:00 --mem=60G --parsable --requeue --comment="eval_best_of_N.n1" scripts/automatic/run.sh 'uv run evaluation/brc_eval_scripts/eval_libero_best_of_N_single_n.py --n 1 --actor_restore_path "exp/multitask_RL/bcflowactor_only/libero_90-living_room_scene1/bcflowactor_livingroomscene1__alphabet_soup_ketchup_25_demos_IMAGE_sd00020251227_144347/params_140000.pkl" --critic_restore_path "exp/multitask_RL/TEST_ASYNC_EVAL_instruction_following_Q/libero_90-living_room_scene1/libero90_livingroomscene1_twotask_augment_each_other_-10_reward_IMAGE_sd000s_30649935.0.20251229_034932/params_150.pkl" --env_name "libero_90-living_room_scene1" --task_name "pick_up_the_alphabet_soup_and_put_it_in_the_basket|pick_up_the_ketchup_and_put_it_in_the_basket" --wandb_entity yajatyadav --wandb_project multitask_RL --wandb_run_id i7489boa --output_dir ./eval_results/run_i7489boa_20251229_035159') && echo $jobid0
jobid1=$(WANDB_MODE=offline WANDB_SERVICE_WAIT=86400 WANDB_NETWORK_TIMEOUT=600 WANDB_FILE_TRANSFER_TIMEOUT=1200 WANDB_INIT_TIMEOUT=300 WANDB_HTTP_TIMEOUT=600 WANDB_RETRY_ATTEMPTS=15 WANDB_RETRY_WAIT_MIN=5 WANDB_RETRY_WAIT_MAX=120 MUJOCO_GL=egl XLA_PYTHON_CLIENT_PREALLOCATE=false OMP_NUM_THREADS=1 OPENBLAS_NUM_THREADS=1 MKL_NUM_THREADS=1 VECLIB_MAXIMUM_THREADS=1 NUMEXPR_NUM_THREADS=1 sbatch -A co_rail -p savio4_gpu --gres=gpu:A5000:1 -N 1 -n 1 -c 4 --qos=rail_gpu4_high -t 24:00:00 --mem=60G --parsable --requeue --comment="eval_best_of_N.n2" scripts/automatic/run.sh 'uv run evaluation/brc_eval_scripts/eval_libero_best_of_N_single_n.py --n 2 --actor_restore_path "exp/multitask_RL/bcflowactor_only/libero_90-living_room_scene1/bcflowactor_livingroomscene1__alphabet_soup_ketchup_25_demos_IMAGE_sd00020251227_144347/params_140000.pkl" --critic_restore_path "exp/multitask_RL/TEST_ASYNC_EVAL_instruction_following_Q/libero_90-living_room_scene1/libero90_livingroomscene1_twotask_augment_each_other_-10_reward_IMAGE_sd000s_30649935.0.20251229_034932/params_150.pkl" --env_name "libero_90-living_room_scene1" --task_name "pick_up_the_alphabet_soup_and_put_it_in_the_basket|pick_up_the_ketchup_and_put_it_in_the_basket" --wandb_entity yajatyadav --wandb_project multitask_RL --wandb_run_id i7489boa --output_dir ./eval_results/run_i7489boa_20251229_035159') && echo $jobid1
jobid2=$(WANDB_MODE=offline WANDB_SERVICE_WAIT=86400 WANDB_NETWORK_TIMEOUT=600 WANDB_FILE_TRANSFER_TIMEOUT=1200 WANDB_INIT_TIMEOUT=300 WANDB_HTTP_TIMEOUT=600 WANDB_RETRY_ATTEMPTS=15 WANDB_RETRY_WAIT_MIN=5 WANDB_RETRY_WAIT_MAX=120 MUJOCO_GL=egl XLA_PYTHON_CLIENT_PREALLOCATE=false OMP_NUM_THREADS=1 OPENBLAS_NUM_THREADS=1 MKL_NUM_THREADS=1 VECLIB_MAXIMUM_THREADS=1 NUMEXPR_NUM_THREADS=1 sbatch -A co_rail -p savio4_gpu --gres=gpu:A5000:1 -N 1 -n 1 -c 4 --qos=rail_gpu4_high -t 24:00:00 --mem=60G --parsable --requeue --comment="eval_best_of_N.n4" scripts/automatic/run.sh 'uv run evaluation/brc_eval_scripts/eval_libero_best_of_N_single_n.py --n 4 --actor_restore_path "exp/multitask_RL/bcflowactor_only/libero_90-living_room_scene1/bcflowactor_livingroomscene1__alphabet_soup_ketchup_25_demos_IMAGE_sd00020251227_144347/params_140000.pkl" --critic_restore_path "exp/multitask_RL/TEST_ASYNC_EVAL_instruction_following_Q/libero_90-living_room_scene1/libero90_livingroomscene1_twotask_augment_each_other_-10_reward_IMAGE_sd000s_30649935.0.20251229_034932/params_150.pkl" --env_name "libero_90-living_room_scene1" --task_name "pick_up_the_alphabet_soup_and_put_it_in_the_basket|pick_up_the_ketchup_and_put_it_in_the_basket" --wandb_entity yajatyadav --wandb_project multitask_RL --wandb_run_id i7489boa --output_dir ./eval_results/run_i7489boa_20251229_035159') && echo $jobid2
jobid3=$(WANDB_MODE=offline WANDB_SERVICE_WAIT=86400 WANDB_NETWORK_TIMEOUT=600 WANDB_FILE_TRANSFER_TIMEOUT=1200 WANDB_INIT_TIMEOUT=300 WANDB_HTTP_TIMEOUT=600 WANDB_RETRY_ATTEMPTS=15 WANDB_RETRY_WAIT_MIN=5 WANDB_RETRY_WAIT_MAX=120 MUJOCO_GL=egl XLA_PYTHON_CLIENT_PREALLOCATE=false OMP_NUM_THREADS=1 OPENBLAS_NUM_THREADS=1 MKL_NUM_THREADS=1 VECLIB_MAXIMUM_THREADS=1 NUMEXPR_NUM_THREADS=1 sbatch -A co_rail -p savio4_gpu --gres=gpu:A5000:1 -N 1 -n 1 -c 4 --qos=rail_gpu4_high -t 24:00:00 --mem=60G --parsable --requeue --comment="eval_best_of_N.n8" scripts/automatic/run.sh 'uv run evaluation/brc_eval_scripts/eval_libero_best_of_N_single_n.py --n 8 --actor_restore_path "exp/multitask_RL/bcflowactor_only/libero_90-living_room_scene1/bcflowactor_livingroomscene1__alphabet_soup_ketchup_25_demos_IMAGE_sd00020251227_144347/params_140000.pkl" --critic_restore_path "exp/multitask_RL/TEST_ASYNC_EVAL_instruction_following_Q/libero_90-living_room_scene1/libero90_livingroomscene1_twotask_augment_each_other_-10_reward_IMAGE_sd000s_30649935.0.20251229_034932/params_150.pkl" --env_name "libero_90-living_room_scene1" --task_name "pick_up_the_alphabet_soup_and_put_it_in_the_basket|pick_up_the_ketchup_and_put_it_in_the_basket" --wandb_entity yajatyadav --wandb_project multitask_RL --wandb_run_id i7489boa --output_dir ./eval_results/run_i7489boa_20251229_035159') && echo $jobid3
jobid4=$(WANDB_MODE=offline WANDB_SERVICE_WAIT=86400 WANDB_NETWORK_TIMEOUT=600 WANDB_FILE_TRANSFER_TIMEOUT=1200 WANDB_INIT_TIMEOUT=300 WANDB_HTTP_TIMEOUT=600 WANDB_RETRY_ATTEMPTS=15 WANDB_RETRY_WAIT_MIN=5 WANDB_RETRY_WAIT_MAX=120 MUJOCO_GL=egl XLA_PYTHON_CLIENT_PREALLOCATE=false OMP_NUM_THREADS=1 OPENBLAS_NUM_THREADS=1 MKL_NUM_THREADS=1 VECLIB_MAXIMUM_THREADS=1 NUMEXPR_NUM_THREADS=1 sbatch -A co_rail -p savio4_gpu --gres=gpu:A5000:1 -N 1 -n 1 -c 4 --qos=rail_gpu4_high -t 24:00:00 --mem=60G --parsable --requeue --comment="eval_best_of_N.n16" scripts/automatic/run.sh 'uv run evaluation/brc_eval_scripts/eval_libero_best_of_N_single_n.py --n 16 --actor_restore_path "exp/multitask_RL/bcflowactor_only/libero_90-living_room_scene1/bcflowactor_livingroomscene1__alphabet_soup_ketchup_25_demos_IMAGE_sd00020251227_144347/params_140000.pkl" --critic_restore_path "exp/multitask_RL/TEST_ASYNC_EVAL_instruction_following_Q/libero_90-living_room_scene1/libero90_livingroomscene1_twotask_augment_each_other_-10_reward_IMAGE_sd000s_30649935.0.20251229_034932/params_150.pkl" --env_name "libero_90-living_room_scene1" --task_name "pick_up_the_alphabet_soup_and_put_it_in_the_basket|pick_up_the_ketchup_and_put_it_in_the_basket" --wandb_entity yajatyadav --wandb_project multitask_RL --wandb_run_id i7489boa --output_dir ./eval_results/run_i7489boa_20251229_035159') && echo $jobid4
jobid5=$(WANDB_MODE=offline WANDB_SERVICE_WAIT=86400 WANDB_NETWORK_TIMEOUT=600 WANDB_FILE_TRANSFER_TIMEOUT=1200 WANDB_INIT_TIMEOUT=300 WANDB_HTTP_TIMEOUT=600 WANDB_RETRY_ATTEMPTS=15 WANDB_RETRY_WAIT_MIN=5 WANDB_RETRY_WAIT_MAX=120 MUJOCO_GL=egl XLA_PYTHON_CLIENT_PREALLOCATE=false OMP_NUM_THREADS=1 OPENBLAS_NUM_THREADS=1 MKL_NUM_THREADS=1 VECLIB_MAXIMUM_THREADS=1 NUMEXPR_NUM_THREADS=1 sbatch -A co_rail -p savio4_gpu --gres=gpu:A5000:1 -N 1 -n 1 -c 4 --qos=rail_gpu4_high -t 24:00:00 --mem=60G --parsable --requeue --comment="eval_best_of_N.n32" scripts/automatic/run.sh 'uv run evaluation/brc_eval_scripts/eval_libero_best_of_N_single_n.py --n 32 --actor_restore_path "exp/multitask_RL/bcflowactor_only/libero_90-living_room_scene1/bcflowactor_livingroomscene1__alphabet_soup_ketchup_25_demos_IMAGE_sd00020251227_144347/params_140000.pkl" --critic_restore_path "exp/multitask_RL/TEST_ASYNC_EVAL_instruction_following_Q/libero_90-living_room_scene1/libero90_livingroomscene1_twotask_augment_each_other_-10_reward_IMAGE_sd000s_30649935.0.20251229_034932/params_150.pkl" --env_name "libero_90-living_room_scene1" --task_name "pick_up_the_alphabet_soup_and_put_it_in_the_basket|pick_up_the_ketchup_and_put_it_in_the_basket" --wandb_entity yajatyadav --wandb_project multitask_RL --wandb_run_id i7489boa --output_dir ./eval_results/run_i7489boa_20251229_035159') && echo $jobid5
jobid6=$(WANDB_MODE=offline WANDB_SERVICE_WAIT=86400 WANDB_NETWORK_TIMEOUT=600 WANDB_FILE_TRANSFER_TIMEOUT=1200 WANDB_INIT_TIMEOUT=300 WANDB_HTTP_TIMEOUT=600 WANDB_RETRY_ATTEMPTS=15 WANDB_RETRY_WAIT_MIN=5 WANDB_RETRY_WAIT_MAX=120 MUJOCO_GL=egl XLA_PYTHON_CLIENT_PREALLOCATE=false OMP_NUM_THREADS=1 OPENBLAS_NUM_THREADS=1 MKL_NUM_THREADS=1 VECLIB_MAXIMUM_THREADS=1 NUMEXPR_NUM_THREADS=1 sbatch -A co_rail -p savio4_gpu --gres=gpu:A5000:1 -N 1 -n 1 -c 4 --qos=rail_gpu4_high -t 24:00:00 --mem=60G --parsable --requeue --comment="eval_best_of_N.n64" scripts/automatic/run.sh 'uv run evaluation/brc_eval_scripts/eval_libero_best_of_N_single_n.py --n 64 --actor_restore_path "exp/multitask_RL/bcflowactor_only/libero_90-living_room_scene1/bcflowactor_livingroomscene1__alphabet_soup_ketchup_25_demos_IMAGE_sd00020251227_144347/params_140000.pkl" --critic_restore_path "exp/multitask_RL/TEST_ASYNC_EVAL_instruction_following_Q/libero_90-living_room_scene1/libero90_livingroomscene1_twotask_augment_each_other_-10_reward_IMAGE_sd000s_30649935.0.20251229_034932/params_150.pkl" --env_name "libero_90-living_room_scene1" --task_name "pick_up_the_alphabet_soup_and_put_it_in_the_basket|pick_up_the_ketchup_and_put_it_in_the_basket" --wandb_entity yajatyadav --wandb_project multitask_RL --wandb_run_id i7489boa --output_dir ./eval_results/run_i7489boa_20251229_035159') && echo $jobid6
jobid7=$(WANDB_MODE=offline WANDB_SERVICE_WAIT=86400 WANDB_NETWORK_TIMEOUT=600 WANDB_FILE_TRANSFER_TIMEOUT=1200 WANDB_INIT_TIMEOUT=300 WANDB_HTTP_TIMEOUT=600 WANDB_RETRY_ATTEMPTS=15 WANDB_RETRY_WAIT_MIN=5 WANDB_RETRY_WAIT_MAX=120 MUJOCO_GL=egl XLA_PYTHON_CLIENT_PREALLOCATE=false OMP_NUM_THREADS=1 OPENBLAS_NUM_THREADS=1 MKL_NUM_THREADS=1 VECLIB_MAXIMUM_THREADS=1 NUMEXPR_NUM_THREADS=1 sbatch -A co_rail -p savio4_gpu --gres=gpu:A5000:1 -N 1 -n 1 -c 4 --qos=rail_gpu4_high -t 24:00:00 --mem=60G --parsable --requeue --comment="eval_best_of_N.n128" scripts/automatic/run.sh 'uv run evaluation/brc_eval_scripts/eval_libero_best_of_N_single_n.py --n 128 --actor_restore_path "exp/multitask_RL/bcflowactor_only/libero_90-living_room_scene1/bcflowactor_livingroomscene1__alphabet_soup_ketchup_25_demos_IMAGE_sd00020251227_144347/params_140000.pkl" --critic_restore_path "exp/multitask_RL/TEST_ASYNC_EVAL_instruction_following_Q/libero_90-living_room_scene1/libero90_livingroomscene1_twotask_augment_each_other_-10_reward_IMAGE_sd000s_30649935.0.20251229_034932/params_150.pkl" --env_name "libero_90-living_room_scene1" --task_name "pick_up_the_alphabet_soup_and_put_it_in_the_basket|pick_up_the_ketchup_and_put_it_in_the_basket" --wandb_entity yajatyadav --wandb_project multitask_RL --wandb_run_id i7489boa --output_dir ./eval_results/run_i7489boa_20251229_035159') && echo $jobid7

# Postprocessing Job
# Waits for all evaluation jobs to complete, then aggregates results

postprocess_jobid=$(sbatch -A co_rail -p savio4_gpu --gres=gpu:A5000:1 -N 1 -n 1 -c 4 --qos=rail_gpu4_high -t 24:00:00 --mem=60G --parsable --dependency=afterok:$jobid0:$jobid1:$jobid2:$jobid3:$jobid4:$jobid5:$jobid6:$jobid7 --comment="postprocess_best_of_N" scripts/automatic/run.sh 'uv run evaluation/brc_eval_scripts/postprocess_best_of_n_eval.py --output_dir ./eval_results/run_i7489boa_20251229_035159 --wandb_entity yajatyadav --wandb_project multitask_RL --wandb_run_id i7489boa --env_name "libero_90-living_room_scene1"') && echo $postprocess_jobid

echo "All jobs submitted!"
echo "Evaluation jobs: 8"
echo "Postprocessing will run after all evaluations complete"
